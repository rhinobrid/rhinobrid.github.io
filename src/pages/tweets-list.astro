---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

import { render } from 'astro:content'
import { Paginator } from 'astro-pure/components/pages'
import { getTweetsCollection, getUniqueTagsWithCount, sortTweetsByDate } from '@/utils/tweets'
import { Button, Icon } from 'astro-pure/user'
import PageLayout from '@/layouts/BaseLayout.astro'
import config from 'virtual:config'

export const prerender = true

export const getStaticPaths = (async ({ paginate }) => {
  const tweets = sortTweetsByDate(await getTweetsCollection())
  const uniqueTags = getUniqueTagsWithCount(tweets).map(([tag]) => tag)
  const tweetsCount = tweets.length
  return paginate(tweets, {
    pageSize: config.content.blogPageSize,
    props: { uniqueTags, tweetsCount }
  })
}) satisfies GetStaticPaths

interface Props {
  page: Page<CollectionEntry<'microposts'>>
  uniqueTags: string[]
  tweetsCount: number
}

const { page, uniqueTags, tweetsCount } = Astro.props

const meta = {
  description: `A collection of ${tweetsCount} tweets`,
  title: 'Tweets'
}

const paginationProps = {
  ...(page.url.prev && {
    prevUrl: {
      text: `← Previous Posts`,
      url: page.url.prev
    }
  }),
  ...(page.url.next && {
    nextUrl: {
      text: `Next Posts →`,
      url: page.url.next
    }
  })
}
---

<PageLayout {meta}>
  <Button title='Back' href='/' variant='back' />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 mt-6 text-3xl font-medium sm:mt-10'>Tweets</h1>
    </div>
    {
      page.data.length === 0 ? (
        <p>No tweets yet.</p>
      ) : (
        <div class='grid gap-y-16 sm:grid-cols-[3fr_1fr] sm:gap-x-8'>
          <section aria-label='Tweets list' class='animate' id='content'>
            {/* header */}
            <div class='mb-3 flex flex-col justify-between text-sm sm:mb-5 sm:flex-row'>
              <span class='text-muted-foreground'>
                Page {page.currentPage} - Showing {page.data.length} of {tweetsCount} posts
              </span>
              <a aria-label='View all tweets by years' href='/tweets/archive' data-astro-prefetch>
                View all tweets by years →
              </a>
            </div>
            {/* tweets */}
            <ul class='flex flex-col gap-y-4 text-start'>
              {page.data.map((tweet) => (
                <li>
                  <a href={`/tweets/post/${tweet.id}`} class='no-underline text-foreground'>
                    <article
                      id={`tweet-${tweet.id}`}
                      class='border border-border bg-card rounded-xl p-5 mb-4 transition-all duration-200 hover:border-primary/30 hover:shadow-md'
                    >
                      {/* Header: Avatar + Meta */}
                      <header class='flex items-start gap-3 mb-4'>
                        <div class='flex-shrink-0'>
                          <img
                            src={config.logo.src}
                            alt={config.author}
                            class='w-10 h-10 rounded-full object-cover'
                            loading='lazy'
                          />
                        </div>
                        <div class='flex-1 min-w-0'>
                          <div class='flex items-baseline gap-2 flex-wrap'>
                            <span class='font-bold text-foreground'>{config.author}</span>
                            <span class='text-muted-foreground text-sm'>@{config.author.toLowerCase().replace(/\s+/g, '')}</span>
                          </div>
                          <time
                            datetime={tweet.data.publishDate.toISOString()}
                            class='text-muted-foreground text-xs mt-1 block'
                          >
                            {new Date(tweet.data.publishDate).toLocaleDateString(config.locale.dateLocale, {
                              year: 'numeric',
                              month: 'long',
                              day: 'numeric',
                              hour: '2-digit',
                              minute: '2-digit'
                            })}
                          </time>
                        </div>
                      </header>
                      {/* Content */}
                      <div class='text-lg leading-relaxed text-foreground/90 mb-4'>
                        <p class='italic text-muted-foreground'>[Tweet content preview...]</p>
                      </div>
                      {/* Footer: Tags */}
                      {tweet.data.tags.length > 0 && (
                        <footer class='pt-4 border-t border-border/50'>
                          <div class='flex flex-wrap gap-2'>
                            {tweet.data.tags.map((tag: string) => (
                              <a
                                href={`/tags/${tag}`}
                                class='text-primary text-sm hover:underline cursor-pointer transition-colors'
                              >
                                #{tag}
                              </a>
                            ))}
                          </div>
                        </footer>
                      )}
                    </article>
                  </a>
                </li>
              ))}
            </ul>
            <Paginator {...paginationProps} />
          </section>

          {/* sidebar */}
          {!!uniqueTags.length && (
            <aside class='animate' id='sidebar'>
              <h2 class='mb-4 flex items-center text-lg font-medium'>
                <Icon name='tag-2' class='me-2' />
                Tweet Tags
              </h2>
              <ul class='text-bgColor flex flex-wrap gap-2'>
                {
                  uniqueTags.slice(0, 50).map((tag) => (
                    <li>
                      <Button title={tag} href={`/tags/${tag}`} variant='pill' />
                    </li>
                  ))
                }
              </ul>
              <span class='mt-4 block sm:text-end'>
                <a aria-label='View all tweet categories' href='/tags' data-astro-prefetch>
                  View all →
                </a>
              </span>
            </aside>
          )}
        </div>
      )
    }
  </main>
</PageLayout>
